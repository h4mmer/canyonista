import { Injectable } from '@angular/core';
import {HttpClient} from "@angular/common/http";
import {TileCoord} from "ol/tilecoord";
import {firstValueFrom, Observable, switchMap} from "rxjs";
import {Tile} from "ol";
import {tile} from "ol/loadingstrategy";
import {LoadFunction} from "ol/Tile";
import {StorageService} from "./storage.service";

@Injectable({
  providedIn: 'root'
})
export class TileService {

  private fallback = "data:image/jpeg;base64,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";
  constructor(private http: HttpClient,private storage:StorageService) {
  }

  private convertBlobToBase64(blob: Blob) :Observable<string>{
    return Observable.create((observer:any) => {
      const reader = new FileReader();
      const binaryString = reader.readAsDataURL(blob);
      reader.onload = (event: any) => {
        observer.next(event.target.result);
        observer.complete();
      };

      reader.onerror = (event: any) => {
        console.log("File could not be read: " + event.target.error.code);
        observer.next(event.target.error.code);
        observer.complete();
      };
    });
  }


  private async get(url:string){
    let img=await this.storage.read(url)
    if(img){
      return img;
    }
    console.log(`get ${url}`)
    img = await firstValueFrom(this.http.get(url,{
      headers:{
        'Accept': 'image/jpeg'
      },responseType: 'blob'
    }).pipe(
        switchMap(blob => this.convertBlobToBase64(blob))
      )).catch(reason => this.fallback);
    if(img != this.fallback){
      this.storage.write(url,img!).catch();
    }
    return img;
  }
  getSource():LoadFunction{
    return async(tile: any,url:string) =>{
      const cords = tile.getTileCoord()
      tile.getImage().src = await this.get(url);
    }
  }

}
